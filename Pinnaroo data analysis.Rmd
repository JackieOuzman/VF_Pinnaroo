---
title: "Pinnaroo analysis"
author: "Jackie Ouzman"
date: "04/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r lib, include=FALSE}
library(dplyr)
library(tidyverse)
library(readr)
library(lubridate)
library(DT)
library(sp)


library(rgdal)
library(sf)

#install.packages("plotKML")
library(plotKML)
library(knitr)
library(png)

library(readxl)


library(ggmap)
library(maps)
library(mapdata)

library(raster)
#library(hms) Add these before I use them?
#library(plyr)
```

## Location of the trial

This information is still to come.

Aim of trial: selective grazing to barley paddock pre harvest

Start date:
End date:

Number of animals:
Date of fence moves:


```{r location of trial, echo=FALSE, message=FALSE, warning=FALSE}
# This information is still to come
#include_graphics("xx.png")


```




## Biomass readings

Pre trial survey
Crop circle and Phenom survey undertaken by Damian on 06/10/2021

Post trial survey
Crop circle and Phenom survey undertaken by Damian on 20/10/2021

**Raw data**

- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Post trial\MAPxxx.CSV"
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Pre trial\MAP00xx.CSV"


- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Pre trial\MAP00xx.CSV"
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Post trial\MAP00xx.CSV"

Note the files are merged and for the Phenom the data is split into sensor 1 and 2.
We have only used sensor 1 for this analysis.

**Rasters** 
CC Pre Trial

"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Pre trial\CC_NDVI\Vesper\CC_HighDensity_NDVI_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Pre trial\CC_LAI\Vesper\CC_HighDensity_LAI_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Pre trial\CC_DIST\Vesper\CC_HighDensity_DIST_PRED_2m.tif"

CC Post Trial
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Post trial\CC_post_trial_NDVI\Vesper\PinarooCCpostmerg_HighDensity_NDVI_PRED_2m.tif"
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Post trial\CC_post_trial_LAI\Vesper\PinarooCCpostmerg_HighDensity_LAI_PRED_2m.tif"
- "\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\CC files\Post trial\CC_post_trial_DIST\Vesper\PinarooCCpostmerg_HighDensity_DIST_PRED_2m.tif"



Phenom Pre Trial
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Pre trial\Phenom_Pre_NDVI\Vesper\pre_trial_Pheonm_sen_HighDensity_NDVI_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Pre trial\Phenom_Pre_LAI\Vesper\pre_trial_Pheonm_sen_HighDensity_LAII_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Pre trial\Phenom_Pre_DIST\Vesper\pre_trial_Pheonm_sen_HighDensity_DIST_PRED_2m.tif"

Phenom Post Trial
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Post trial\Phenom_post_trial_NDVI\Vesper\post_trial_Pheonm_se_HighDensity_NDVI_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Post trial\Phenom_post_trial_LAI\Vesper\post_trial_Pheonm_se_HighDensity_LAI_PRED_2m.tif"
"\\FSSA2-ADL\clw-share1\Microlab\VF\Pinnaroo\Biomass_data_maps\Phenom files\Post trial\Phenom_post_trial_DIST\Vesper\post_trial_Pheonm_se_HighDensity_DIST_PRED_2m.tif"



Data processing done by Jackie using the following settings:

- Block boundaries created in google earth pro.

- Data cleaned and trimmed using PAT QGIS tools, standard default settings used

- Block boundaries drawn based on GPS points

- Block grid of 2m pixel made

- Vesper used for kriging cleaned data

- Vesper setting include; block kriging with a block size of 10m

- Data in below map is displayed as quantile.

# Biomass measure

Biomass measured were taken before and after the trial was run.
Dates:


```{r biomass pre and post_trial, echo=FALSE, message=FALSE, warning=FALSE}
pre_post_trial_biomass <- read.csv("W:/VF/Pinnaroo/Biomass_data_maps/Pinnaroo_maps/extract_grid_pts_pre_trial.csv")
#select only the pre trial data pts.
#names(pre_post_trial_biomass)

biomass_ave_pre_post <- pre_post_trial_biomass %>% 
  group_by(timing) %>% 
  summarise(av_BM = mean(BM__kg___H, na.rm= FALSE ),
            st_dev = sd(BM__kg___H, na.rm= FALSE),
            count = n())

datatable(biomass_ave_pre_post,
          options = list(dom = 't'),#removes the search bar
          caption = 'Biomass measures kg /Ha.',
          rownames = FALSE,
          colnames = c('Timing', 'Av Biomass', 'St dev biomass', 'Count')) %>% 
  formatRound(c(2:3), 0)
```


## Pre trial maps

```{r cc_and phenom pre_trial, echo=FALSE, message=FALSE, warning=FALSE}

include_graphics("W:/VF/Pinnaroo/Biomass_data_maps/Pinnaroo_maps/Pre_trial_biomass.png")


```


## plot of biomass vs survey data pre trial

```{r pre_trial biomass vs biomass survey, echo=FALSE, message=FALSE, warning=FALSE}

pre_post_trial_biomass <- read.csv("W:/VF/Pinnaroo/Biomass_data_maps/Pinnaroo_maps/extract_grid_pts_pre_trial.csv")
#select only the pre trial data pts.
#names(pre_post_trial_biomass)
#rename some clm this is the order that was extered when extrcated in Arcmap
pre_post_trial_biomass <- pre_post_trial_biomass %>% 
  rename(Survey_Phen_DIST = pre_trial_,
         Survey_Phen_LAI = pre_trial1,
         Survey_Phen_NDVI = pre_tria_1,
         Survey_CC_DIST = cc_all_Hig,
         Survey_CC_LAI = CC_HighDen,
         Survey_CC_NDVI = CC_HighD_1)


#### how does the biomass pre trial relate to the pre trial biomass survey data?
pre_trial_biomass <- pre_post_trial_biomass %>% 
  filter(timing == "pre_trial")


#let rearragne the data so I can do a facet wrap
pre_trial_biomass_long <- pre_trial_biomass %>% 
pivot_longer(cols = starts_with("Survey"),
             names_to = "survey_type",
             values_to = "value")


#http://www.sthda.com/english/wiki/ggplot2-scatter-plots-quick-start-guide-r-software-and-data-visualization
# method : smoothing method to be used. Possible values are lm, glm, gam, loess, rlm.
# method = “loess”: This is the default value for small number of observations. It computes a smooth local regression. You can read more about loess using the R code ?loess.
# method =“lm”: It fits a linear model. Note that, it’s also possible to indicate the formula as formula = y ~ poly(x, 3) to specify a degree 3 polynomial.
# se : logical value. If TRUE, confidence interval is displayed around smooth.
# fullrange : logical value. If TRUE, the fit spans the full range of the plot
# level : level of confidence interval to use. Default value is 0.95

plot1 <- pre_trial_biomass_long %>%
  #filter(survey_type == "Survey_CC_NDVI") %>% 
  ggplot(aes(x = BM__kg___H  , y = value)) +
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  #geom_smooth(se = FALSE)+
  facet_wrap(.~survey_type, scales = "free_y")+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))+
  labs(
    x = paste0("biomass cuts "),
    y = "survey data",
    title = "Pre trial data"
  )
plot1
```




## The fit of models biomass vs survey data pre trial

```{r pre_trial biomass vs biomass survey model fit, echo=FALSE, message=FALSE, warning=FALSE}



#http://www.sthda.com/english/articles/40-regression-analysis/167-simple-linear-regression-in-r/
  
  

pre_trial_biomass_long_CC_NDVI_pre <- pre_trial_biomass_long %>% 
  filter(survey_type == "Survey_CC_NDVI")
pre_trial_biomass_long_CC_LAI_pre <- pre_trial_biomass_long %>% 
  filter(survey_type == "Survey_CC_LAI")
pre_trial_biomass_long_CC_DIST_pre <- pre_trial_biomass_long %>% 
  filter(survey_type == "Survey_CC_DIST")


cor_pre_CC_NDVI <- cor(pre_trial_biomass_long_CC_NDVI_pre$value, 
                       pre_trial_biomass_long_CC_NDVI_pre$BM__kg___H)
cor_pre_CC_LAI <- cor(pre_trial_biomass_long_CC_LAI_pre$value, 
                      pre_trial_biomass_long_CC_LAI_pre$BM__kg___H)
cor_pre_CC_DIST <- cor(pre_trial_biomass_long_CC_DIST_pre$value, 
                       pre_trial_biomass_long_CC_DIST_pre$BM__kg___H) 

#Make a table with the analysis correlation table

pre_trial_table <- data.frame(survey  = c("NDVI", "LAI", "DIST"),
                              survey_type  = c("Crop Circle", "Crop Circle", "Crop Circle"),
                                correlation = c(cor_pre_CC_NDVI, cor_pre_CC_LAI, cor_pre_CC_DIST),
                                timing  = c("pre_trial", "pre_trial", "pre_trial"))



model_pre_CC_NDVI <- summary(lm(value ~ BM__kg___H, 
                        data = pre_trial_biomass_long_CC_NDVI_pre))
model_pre_CC_LAI <- summary(lm(value ~ BM__kg___H, 
                        data = pre_trial_biomass_long_CC_LAI_pre))
model_pre_CC_DIST <- summary(lm(value ~ BM__kg___H, 
                        data = pre_trial_biomass_long_CC_DIST_pre))



# model_pre_CC_NDVI
# model_pre_CC_NDVI$coefficients[1,1] #b0 Intercept
# model_pre_CC_NDVI$coefficients[2,1] #b1 slope
# model_pre_CC_NDVI$sigma #(Residual Standard Error from Linear Regression Model)
# model_pre_CC_NDVI$adj.r.squared
# model_pre_CC_NDVI$r.squared

#add this info to the pre_trial_table

pre_trial_model_table <- data.frame(survey  = c("NDVI", "LAI", "DIST"),
                                    Intercept = c(model_pre_CC_NDVI$coefficients[1,1], model_pre_CC_LAI$coefficients[1,1], model_pre_CC_DIST$coefficients[1,1]),
                                    Slope = c(model_pre_CC_NDVI$coefficients[2,1], model_pre_CC_LAI$coefficients[2,1], model_pre_CC_DIST$coefficients[2,1]),
                                    RSE = c(model_pre_CC_NDVI$sigma, model_pre_CC_LAI$sigma, model_pre_CC_DIST$sigma),
                                    R_Square = c(model_pre_CC_NDVI$r.squared, model_pre_CC_LAI$r.squared, model_pre_CC_DIST$r.squared),
                                    Adj_R_Square = c(model_pre_CC_NDVI$adj.r.squared, model_pre_CC_LAI$adj.r.squared,model_pre_CC_DIST$adj.r.squared)
)
                                    
                                    


pre_trial_model <- left_join(pre_trial_table, pre_trial_model_table)

pre_trial_model <- pre_trial_model[, c(4, 1, 2, 3, 5,6,7,8)]


datatable(pre_trial_model,
          options = list(dom = 't'),#removes the search bar
          caption = 'Details of the models.',
          rownames = FALSE)%>%
           formatRound(c(4:5, 7:10), 2) %>% 
           formatRound(6, 5)

```


Need to do this for the phenom data set

## Post trial maps

```{r cc_and phenom post_trial, echo=FALSE, message=FALSE, warning=FALSE}

include_graphics("W:/VF/Pinnaroo/Biomass_data_maps/Pinnaroo_maps/Post_trial_biomass.png")


```


## plot of biomass vs survey data post trial

```{r post_trial biomass vs biomass survey, echo=FALSE, message=FALSE, warning=FALSE}


```

